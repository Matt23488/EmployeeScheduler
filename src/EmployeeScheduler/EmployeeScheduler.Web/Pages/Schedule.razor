@page "/schedule"
@page "/schedule/{ID:long}"
@using Lib.Extensions


@if (Schedule_ == null)
{
    <em>Loading...</em>
}
else
{
    <h1>
        @Schedule_.Date().ToString("MMM d") - @Schedule_.Date().AddDays(6).ToString("MMM d")
        @if (Scheduler.GetScheduleID(DateTime.Now) == Schedule_.ID)
        {
            <span class="text-primary">Current</span>
        }
    </h1>
    <div class="float-left">
        <button class="btn btn-success" @onclick="SaveSchedule"><i class="oi oi-check"></i> Save</button>
    </div>
    <div class="float-right">
        <a href="schedule/@(PreviousWeekID)" class="btn btn-primary"><i class="oi oi-arrow-left"></i></a>
        <a href="schedule/@(NextWeekID)" class="btn btn-primary"><i class="oi oi-arrow-right"></i></a>
    </div>
    <div class="clearfix"></div>
    <br />
    <EmployeeScheduler.Web.Shared.Schedule.EmployeeDay Closed="Schedule_.Sunday.IsClosed" DayString="Sunday" @ref="Sunday" Date="@Schedule_.Date().AddDays(0)" EmployeeDays="@GetDay(w => w.Sunday)" />
    <EmployeeScheduler.Web.Shared.Schedule.EmployeeDay Closed="Schedule_.Monday.IsClosed" DayString="Monday" @ref="Monday" Date="@Schedule_.Date().AddDays(1)" EmployeeDays="@GetDay(w => w.Monday)" />
    <EmployeeScheduler.Web.Shared.Schedule.EmployeeDay Closed="Schedule_.Tuesday.IsClosed" DayString="Tuesday" @ref="Tuesday" Date="@Schedule_.Date().AddDays(2)" EmployeeDays="@GetDay(w => w.Tuesday)" />
    <EmployeeScheduler.Web.Shared.Schedule.EmployeeDay Closed="Schedule_.Wednesday.IsClosed" DayString="Wednesday" @ref="Wednesday" Date="@Schedule_.Date().AddDays(3)" EmployeeDays="@GetDay(w => w.Wednesday)" />
    <EmployeeScheduler.Web.Shared.Schedule.EmployeeDay Closed="Schedule_.Thursday.IsClosed" DayString="Thursday" @ref="Thursday" Date="@Schedule_.Date().AddDays(4)" EmployeeDays="@GetDay(w => w.Thursday)" />
    <EmployeeScheduler.Web.Shared.Schedule.EmployeeDay Closed="Schedule_.Friday.IsClosed" DayString="Friday" @ref="Friday" Date="@Schedule_.Date().AddDays(5)" EmployeeDays="@GetDay(w => w.Friday)" />
    <EmployeeScheduler.Web.Shared.Schedule.EmployeeDay Closed="Schedule_.Saturday.IsClosed" DayString="Saturday" @ref="Saturday" Date="@Schedule_.Date().AddDays(6)" EmployeeDays="@GetDay(w => w.Saturday)" />
}

@inject Lib.Services.ILogger Logger
@inject Lib.Services.ISchedulingService Scheduler
@inject Lib.Services.IToastService Toast
@inject IJSRuntime JSRuntime
@inject NavigationManager Nav
@code {
    [Parameter]
    public long ID { get; set; }

    public Lib.DTO.ScheduleWeek Schedule_ { get; set; }
    public List<Lib.DTO.Employee> Employees { get; set; }
    public List<EmployeeWeek> EmployeeWeeks { get; set; }

    private long PreviousWeekID { get; set; }
    private long NextWeekID { get; set; }

    private bool AutoSave => false;

    private Shared.Schedule.EmployeeDay Sunday { get; set; }
    private Shared.Schedule.EmployeeDay Monday { get; set; }
    private Shared.Schedule.EmployeeDay Tuesday { get; set; }
    private Shared.Schedule.EmployeeDay Wednesday { get; set; }
    private Shared.Schedule.EmployeeDay Thursday { get; set; }
    private Shared.Schedule.EmployeeDay Friday { get; set; }
    private Shared.Schedule.EmployeeDay Saturday { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Employees = await Scheduler.GetEmployeesAsync(includeDeleted: true);

        if (Employees.Count(e => e.Active) == 0)
        {
            Nav.NavigateTo($"{Nav.BaseUri}employees");
            return;
        }

        if (AutoSave)
        {
            // TODO: might need to make sure a new timer isn't started if the user refreshes the page.
            var timer = new System.Timers.Timer(10000)
            {
                AutoReset = true,
                Enabled = true
            };

            timer.Elapsed += async (s, e) =>
            {
                if (Nav.Uri != $"{Nav.BaseUri}schedule")
                {
                    timer.Stop();
                    return;
                }

                await SaveSchedule();
            };
        }

        // Shut up about the SUN!
        await Task.FromResult(0);
    }

    protected override async Task OnParametersSetAsync()
    {
        if (ID == 0) Schedule_ = await Scheduler.GetCurrentScheduleAsync();
        else Schedule_ = await Scheduler.GetScheduleAsync(ID);

        PreviousWeekID = Scheduler.GetScheduleID(Schedule_.Date().AddDays(-7));
        NextWeekID = Scheduler.GetScheduleID(Schedule_.Date().AddDays(7));

        EmployeeWeeks = Employees.Select(e => new EmployeeWeek
        {
            Employee = e,
            Sunday = Schedule_.Sunday.EmployeeSchedules?.SingleOrDefault(d => d.EmployeeID == e.ID) ?? new Lib.DTO.EmployeeSchedule(),
            Monday = Schedule_.Monday.EmployeeSchedules?.SingleOrDefault(d => d.EmployeeID == e.ID) ?? new Lib.DTO.EmployeeSchedule(),
            Tuesday = Schedule_.Tuesday.EmployeeSchedules?.SingleOrDefault(d => d.EmployeeID == e.ID) ?? new Lib.DTO.EmployeeSchedule(),
            Wednesday = Schedule_.Wednesday.EmployeeSchedules?.SingleOrDefault(d => d.EmployeeID == e.ID) ?? new Lib.DTO.EmployeeSchedule(),
            Thursday = Schedule_.Thursday.EmployeeSchedules?.SingleOrDefault(d => d.EmployeeID == e.ID) ?? new Lib.DTO.EmployeeSchedule(),
            Friday = Schedule_.Friday.EmployeeSchedules?.SingleOrDefault(d => d.EmployeeID == e.ID) ?? new Lib.DTO.EmployeeSchedule(),
            Saturday = Schedule_.Saturday.EmployeeSchedules?.SingleOrDefault(d => d.EmployeeID == e.ID) ?? new Lib.DTO.EmployeeSchedule(),
        }).ToList();
    }

    private List<Shared.Schedule.EmployeeDay.EmployeeDayDTO> GetDay(Func<EmployeeWeek, Lib.DTO.EmployeeSchedule> accessor)
    {
        return EmployeeWeeks.Select(w =>
        {
            var day = accessor(w);
            day.EmployeeID = w.Employee.ID;
            return new Shared.Schedule.EmployeeDay.EmployeeDayDTO
            {
                Employee = w.Employee,
                Day = day
            };
        }).ToList();
    }

    private async Task SaveSchedule()
    {
        Schedule_.Sunday.EmployeeSchedules = Sunday.EmployeeDays.Select(d => d.Day).ToList();
        Schedule_.Monday.EmployeeSchedules = Monday.EmployeeDays.Select(d => d.Day).ToList();
        Schedule_.Tuesday.EmployeeSchedules = Tuesday.EmployeeDays.Select(d => d.Day).ToList();
        Schedule_.Wednesday.EmployeeSchedules = Wednesday.EmployeeDays.Select(d => d.Day).ToList();
        Schedule_.Thursday.EmployeeSchedules = Thursday.EmployeeDays.Select(d => d.Day).ToList();
        Schedule_.Friday.EmployeeSchedules = Friday.EmployeeDays.Select(d => d.Day).ToList();
        Schedule_.Saturday.EmployeeSchedules = Saturday.EmployeeDays.Select(d => d.Day).ToList();

        Schedule_.Sunday.IsClosed = Sunday.Closed;
        Schedule_.Monday.IsClosed = Monday.Closed;
        Schedule_.Tuesday.IsClosed = Tuesday.Closed;
        Schedule_.Wednesday.IsClosed = Wednesday.Closed;
        Schedule_.Thursday.IsClosed = Thursday.Closed;
        Schedule_.Friday.IsClosed = Friday.Closed;
        Schedule_.Saturday.IsClosed = Saturday.Closed;

        await Scheduler.SaveScheduleAsync(Schedule_);
        await Toast.ShowAsync("Schedule saved!", Lib.Services.ToastType.Success);
    }

    public class EmployeeWeek
    {
        public Lib.DTO.Employee Employee { get; set; }
        public Lib.DTO.EmployeeSchedule Sunday { get; set; }
        public Lib.DTO.EmployeeSchedule Monday { get; set; }
        public Lib.DTO.EmployeeSchedule Tuesday { get; set; }
        public Lib.DTO.EmployeeSchedule Wednesday { get; set; }
        public Lib.DTO.EmployeeSchedule Thursday { get; set; }
        public Lib.DTO.EmployeeSchedule Friday { get; set; }
        public Lib.DTO.EmployeeSchedule Saturday { get; set; }
    }
}